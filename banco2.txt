-- Database: boleto_manager_ai
-- This schema defines the structure for the Boleto Manager AI application,
-- including multi-company support.

--
-- Table structure for table `companies`
-- Stores company information for multi-tenancy.
--
CREATE TABLE IF NOT EXISTS `companies` (
  `id` VARCHAR(36) NOT NULL COMMENT 'UUID for the company',
  `name` VARCHAR(255) NOT NULL,
  `cnpj` VARCHAR(20) DEFAULT NULL,
  `address` VARCHAR(255) DEFAULT NULL,
  `monitored_folder_path` VARCHAR(255) DEFAULT NULL COMMENT 'Path of the folder being monitored for automatic uploads',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;


--
-- Table structure for table `users`
-- Stores user account information, including credentials, roles, and company association.
--
CREATE TABLE IF NOT EXISTS `users` (
  `id` VARCHAR(36) NOT NULL COMMENT 'UUID for the user',
  `username` VARCHAR(255) NOT NULL COMMENT 'User''s email address, used for login',
  `password` VARCHAR(255) NOT NULL COMMENT 'Hashed password for security',
  `role` ENUM('viewer', 'editor', 'admin') NOT NULL DEFAULT 'viewer' COMMENT 'User role for authorization',
  `company_id` VARCHAR(36) DEFAULT NULL COMMENT 'Foreign key linking to the company',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `username_UNIQUE` (`username`),
  KEY `company_id_fk_idx` (`company_id`),
  CONSTRAINT `users_company_id_fk` FOREIGN KEY (`company_id`) REFERENCES `companies` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Table structure for table `boletos`
-- Stores all information related to the uploaded boleto payment slips, segregated by company.
--
CREATE TABLE IF NOT EXISTS `boletos` (
  `id` VARCHAR(36) NOT NULL COMMENT 'UUID for the boleto',
  `user_id` VARCHAR(36) NOT NULL COMMENT 'Foreign key linking to the user who uploaded it',
  `company_id` VARCHAR(36) NOT NULL COMMENT 'Foreign key linking to the company',
  `recipient` VARCHAR(255) DEFAULT NULL COMMENT 'Beneficiário',
  `drawee` VARCHAR(255) DEFAULT NULL COMMENT 'Sacado',
  `document_date` DATE DEFAULT NULL,
  `due_date` DATE DEFAULT NULL,
  `document_amount` DECIMAL(10,2) DEFAULT NULL,
  `amount` DECIMAL(10,2) DEFAULT NULL,
  `discount` DECIMAL(10,2) DEFAULT NULL,
  `interest_and_fines` DECIMAL(10,2) DEFAULT NULL,
  `barcode` VARCHAR(255) DEFAULT NULL COMMENT 'Linha digitável',
  `guide_number` VARCHAR(255) DEFAULT NULL COMMENT 'Número do documento',
  `pix_qr_code_text` TEXT DEFAULT NULL,
  `status` ENUM('PAGAR', 'VERIFICAR', 'PAGO') NOT NULL DEFAULT 'PAGAR',
  `file_name` VARCHAR(255) NOT NULL,
  `file_data` MEDIUMTEXT NOT NULL COMMENT 'Base64 encoded PDF data for viewing/downloading',
  `comments` TEXT DEFAULT NULL,
  `extracted_data` JSON DEFAULT NULL COMMENT 'JSON object with all raw extracted data',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `user_id_fk_idx` (`user_id`),
  KEY `company_id_fk_idx` (`company_id`),
  KEY `barcode_idx` (`barcode`),
  CONSTRAINT `boletos_user_id_fk` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `boletos_company_id_fk` FOREIGN KEY (`company_id`) REFERENCES `companies` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Table structure for table `activity_logs`
-- Records significant actions performed by users for auditing and tracking.
--
CREATE TABLE IF NOT EXISTS `activity_logs` (
  `id` VARCHAR(36) NOT NULL COMMENT 'UUID for the log entry',
  `user_id` VARCHAR(36) NOT NULL,
  `username` VARCHAR(255) NOT NULL,
  `action` VARCHAR(50) NOT NULL COMMENT 'The type of action performed (e.g., LOGIN, CREATE_BOLETO)',
  `details` TEXT COMMENT 'A description of the action',
  `timestamp` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `user_id_idx` (`user_id`),
  KEY `action_idx` (`action`),
  KEY `timestamp_idx` (`timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Table structure for table `settings`
-- Stores global application settings using a flexible key-value pair system.
--
CREATE TABLE IF NOT EXISTS `settings` (
  `id` INT AUTO_INCREMENT,
  `setting_key` VARCHAR(255) NOT NULL,
  `setting_value` TEXT,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `setting_key_UNIQUE` (`setting_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--
-- Initial data for `settings` table
-- Pre-populates the settings with default values on the first run.
--
INSERT INTO `settings` (`setting_key`, `setting_value`) VALUES
('whitelabel_appName', 'Boleto Manager AI'),
('whitelabel_logoUrl', ''),
('processing_method', 'ai'),
('ai_settings', '{"model": "gemini-2.5-flash", "temperature": 0.2, "topK": 1, "topP": 1}'),
('API_KEY', ''),
('JWT_SECRET', '')
ON DUPLICATE KEY UPDATE `setting_value` = VALUES(`setting_value`);