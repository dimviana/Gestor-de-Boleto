#!/bin/bash

# --- Configuration ---
# These variables are used across install, update, and uninstall functions.
GIT_REPO="https://github.com/dimviana/Gestor-de-Boleto.git"
PROJECT_FOLDER="boletomanager.abildeveloper.com.br"
# Updated APP_URL to reflect one of the new Nginx ports
APP_URL="http://boletomanager.abildeveloper.com.br:3000"
DB_HOST="localhost"
DB_USER="root"
DB_PASSWORD="dvsviana"
DB_DATABASE="boleto_manager_ai"
API_KEY="AIzaSyB0zoSEGrIYuRjBtcTvxJX9LVbo5L2GpmA"
JWT_SECRET="AIzaSyB0zoSEGrIYuRjBtcTvxJX9LVbo5L2GpmAjwt"
APP_NAME="boleto-manager-ai" # Name for the PM2 process
APP_PORT=3002 # Internal port for the Node.js application

# Color codes for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# --- Helper Functions ---
command_exists() {
    command -v "$1" &> /dev/null
}

# --- Core Functions ---

install_dependencies() {
    echo -e "${YELLOW}Updating system package list...${NC}"
    sudo apt-get update -y

    echo -e "${YELLOW}Installing essential system packages (git, nginx, mysql-server, build-essential...)${NC}"
    # Replaced apache2 with nginx
    sudo apt-get install -y git curl build-essential python3 nginx mysql-server

    if ! command_exists node; then
        echo "Node.js not found. Installing Node.js LTS (20.x)..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        sudo apt-get install -y nodejs
    else
        echo -e "${GREEN}Node.js is already installed.${NC}"
    fi

    if ! command_exists pm2; then
        echo "PM2 not found. Installing globally..."
        sudo npm install -g pm2
    else
        echo -e "${GREEN}PM2 is already installed.${NC}"
    fi

    echo -e "${GREEN}System dependencies are up to date.${NC}"
}

configure_mysql() {
    echo -e "${YELLOW}Attempting to configure MySQL root password to '${DB_PASSWORD}'...${NC}"
    sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${DB_PASSWORD}';"
    sudo mysql -e "FLUSH PRIVILEGES;"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}MySQL root password configured successfully.${NC}"
    else
        echo -e "${YELLOW}Could not set MySQL password. It might be already set. Continuing...${NC}"
    fi
}

configure_nginx() {
    echo -e "${YELLOW}Configuring Nginx reverse proxy...${NC}"
    
    # Create the Nginx vhost configuration file
    NGINX_CONF="/etc/nginx/sites-available/${PROJECT_FOLDER}"
    echo -e "${YELLOW}Creating Nginx config at ${NGINX_CONF}${NC}"

    sudo tee "$NGINX_CONF" > /dev/null <<EOL
# Vhost listening on port 3000, proxying to the Node app on port ${APP_PORT}
server {
    listen 3000;
    server_name ${PROJECT_FOLDER};

    location / {
        proxy_pass http://localhost:${APP_PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}

# Vhost listening on port 3001, also proxying to the Node app on port ${APP_PORT}
server {
    listen 3001;
    server_name ${PROJECT_FOLDER};

    location / {
        proxy_pass http://localhost:${APP_PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOL

    # Disable the default Nginx site
    if [ -L "/etc/nginx/sites-enabled/default" ]; then
        echo -e "${YELLOW}Disabling default Nginx site...${NC}"
        sudo rm /etc/nginx/sites-enabled/default
    fi

    # Enable the new site by creating a symlink
    if [ ! -L "/etc/nginx/sites-enabled/${PROJECT_FOLDER}" ]; then
        echo -e "${YELLOW}Enabling new Nginx site...${NC}"
        sudo ln -s "$NGINX_CONF" "/etc/nginx/sites-enabled/"
    fi
    
    # Test Nginx configuration and restart the service
    echo -e "${YELLOW}Testing Nginx configuration...${NC}"
    sudo nginx -t
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Nginx config test successful.${NC}"
        echo -e "${YELLOW}Restarting Nginx service...${NC}"
        sudo systemctl restart nginx
    else
        echo -e "${RED}Nginx configuration test failed. Please check the config file at ${NGINX_CONF}${NC}"
        exit 1
    fi
}


# --- Main Logic Functions ---

do_install() {
    echo -e "${GREEN}--- Starting Full Installation ---${NC}"

    install_dependencies
    configure_mysql
    configure_nginx

    if [ -d "$PROJECT_FOLDER" ]; then
        echo -e "${YELLOW}Project folder '$PROJECT_FOLDER' already exists. Removing for a fresh clone.${NC}"
        rm -rf "$PROJECT_FOLDER"
    fi

    echo -e "${YELLOW}Cloning repository...${NC}"
    git clone "$GIT_REPO" "$PROJECT_FOLDER"
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to clone repository.${NC}"; exit 1; fi
    cd "$PROJECT_FOLDER"

    echo -e "${YELLOW}Creating .env configuration file...${NC}"
    cat > .env << EOL
DB_HOST=${DB_HOST}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
DB_DATABASE=${DB_DATABASE}
API_KEY=${API_KEY}
PORT=${APP_PORT}
JWT_SECRET=${JWT_SECRET}
EOL

    echo -e "${YELLOW}Installing project dependencies (npm install)...${NC}"
    npm install
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to install npm dependencies.${NC}"; exit 1; fi

    echo -e "${YELLOW}Compiling TypeScript project (npm run build)...${NC}"
    npm run build
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to compile TypeScript project.${NC}"; exit 1; fi

    echo -e "${YELLOW}Setting up database schema...${NC}"
    echo "CREATE DATABASE IF NOT EXISTS \`${DB_DATABASE}\`; USE \`${DB_DATABASE}\`;" > setup.sql
    cat database/schema.txt >> setup.sql
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" < setup.sql
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to set up database schema.${NC}"; rm setup.sql; exit 1; fi
    rm setup.sql

    echo -e "${YELLOW}Creating default admin user...${NC}"
    ADMIN_UUID=$(node -e "console.log(require('crypto').randomUUID());")
    ADMIN_PASSWORD="dvsviana154"
    HASHED_PASSWORD=$(node -e "console.log(require('bcryptjs').hashSync('${ADMIN_PASSWORD}', 10));")
    INSERT_ADMIN_SQL="INSERT INTO users (id, username, password, role) VALUES ('${ADMIN_UUID}', 'androoiddiviana@gmal.com', '${HASHED_PASSWORD}', 'admin') ON DUPLICATE KEY UPDATE password='${HASHED_PASSWORD}';"
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" "${DB_DATABASE}" -e "${INSERT_ADMIN_SQL}"
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to create admin user.${NC}"; exit 1; fi

    echo -e "${YELLOW}Starting application with PM2...${NC}"
    pm2 stop "$APP_NAME" &> /dev/null
    pm2 delete "$APP_NAME" &> /dev/null
    pm2 start dist/api/index.js --name "$APP_NAME"
    pm2 startup
    pm2 save
    
    echo -e "${GREEN}--- Installation Complete! ---${NC}"
    echo -e "Application is running. Access it via Nginx at: ${YELLOW}${APP_URL}${NC} or ${YELLOW}http://boletomanager.abildeveloper.com.br:3001${NC}"
    echo -e "The Node.js app is running directly on port: ${YELLOW}${APP_PORT}${NC}"
    echo -e "To see logs, run: ${YELLOW}pm2 logs ${APP_NAME}${NC}"
}

do_update() {
    echo -e "${GREEN}--- Starting Application Update ---${NC}"

    if [ ! -d "$PROJECT_FOLDER" ]; then
        echo -e "${RED}Project folder '$PROJECT_FOLDER' not found. Please install the application first.${NC}"
        exit 1
    fi
    cd "$PROJECT_FOLDER"

    echo -e "${YELLOW}Stopping application with PM2...${NC}"
    pm2 stop "$APP_NAME"

    echo -e "${YELLOW}Pulling latest changes from Git...${NC}"
    git pull
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to pull from git repository.${NC}"; pm2 restart "$APP_NAME"; exit 1; fi

    echo -e "${YELLOW}Installing/updating project dependencies (npm install)...${NC}"
    npm install
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to install npm dependencies.${NC}"; pm2 restart "$APP_NAME"; exit 1; fi

    echo -e "${YELLOW}Re-compiling TypeScript project (npm run build)...${NC}"
    npm run build
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to compile TypeScript project.${NC}"; pm2 restart "$APP_NAME"; exit 1; fi
    
    echo -e "${YELLOW}Applying latest database schema changes...${NC}"
    echo "USE \`${DB_DATABASE}\`;" > update.sql
    cat database/schema.txt >> update.sql
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" < update.sql
    rm update.sql
    
    echo -e "${YELLOW}Restarting application with PM2...${NC}"
    pm2 restart "$APP_NAME"

    echo -e "${GREEN}--- Update Complete! ---${NC}"
}

do_uninstall() {
    echo -e "${RED}--- Starting Full Uninstallation ---${NC}"
    echo -e "${YELLOW}This will remove the application, its database, and optionally the system dependencies.${NC}"
    
    read -p "Are you sure you want to continue? [y/N] " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Uninstall cancelled."
        exit 0
    fi

    echo -e "${YELLOW}Stopping and deleting PM2 process...${NC}"
    pm2 stop "$APP_NAME" &> /dev/null
    pm2 delete "$APP_NAME" &> /dev/null
    pm2 save --force

    read -p "Remove Nginx configuration? [y/N] " confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        echo -e "${YELLOW}Removing Nginx vhost...${NC}"
        sudo rm "/etc/nginx/sites-enabled/${PROJECT_FOLDER}" &> /dev/null
        sudo rm "/etc/nginx/sites-available/${PROJECT_FOLDER}" &> /dev/null
        echo -e "${YELLOW}Restarting Nginx...${NC}"
        sudo systemctl restart nginx
    fi
    
    if [ -d "$PROJECT_FOLDER" ]; then
        read -p "Delete project folder at '${PROJECT_FOLDER}'? [y/N] " confirm
        if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
            echo -e "${YELLOW}Deleting project folder...${NC}"
            rm -rf "$PROJECT_FOLDER"
        fi
    fi

    read -p "Drop MySQL database '${DB_DATABASE}'? ${RED}THIS CANNOT BE UNDONE.${NC} [y/N] " confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        echo -e "${YELLOW}Dropping database...${NC}"
        mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" -e "DROP DATABASE IF EXISTS \`${DB_DATABASE}\`;"
    fi

    read -p "Uninstall system-wide dependencies (nginx, mysql, nodejs, pm2)? ${YELLOW}This might affect other applications.${NC} [y/N] " confirm
    if [[ "$confirm" == "y" || "$confirm" == "Y" ]]; then
        echo -e "${YELLOW}Uninstalling PM2...${NC}"
        sudo npm uninstall -g pm2
        echo -e "${YELLOW}Purging system packages...${NC}"
        sudo apt-get purge --auto-remove -y nginx mysql-server* nodejs
        sudo apt-get autoremove -y
        sudo apt-get clean
        echo -e "${YELLOW}Note: Some configuration files might remain in /etc/mysql and /etc/nginx.${NC}"
    fi

    echo -e "${GREEN}--- Uninstallation Complete! ---${NC}"
}

# --- Main Menu ---
clear
echo -e "${GREEN}=============================================${NC}"
echo -e "${GREEN}   Management Script - Boleto Manager AI   ${NC}"
echo -e "${GREEN}=============================================${NC}"
echo ""
echo "Please choose an option:"
echo "  1) Install Application (Fresh Start)"
echo "  2) Update Application (Git Pull & Restart)"
echo "  3) Uninstall Application (Remove Everything)"
echo "  *) Exit"
echo ""
read -p "Enter your choice [1-3]: " choice

case $choice in
    1)
        do_install
        ;;
    2)
        do_update
        ;;
    3)
        do_uninstall
        ;;
    *)
        echo "Exiting."
        exit 0
        ;;
esac