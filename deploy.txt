#!/bin/bash

# Color codes for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}=============================================${NC}"
echo -e "${GREEN}   Deploy Automático - Boleto Manager AI   ${NC}"
echo -e "${GREEN}=============================================${NC}"
echo ""

# --- 1. Verificação e Instalação de Dependências ---
echo -e "${YELLOW}Verificando e instalando dependências... (Pode ser necessário inserir a senha sudo)${NC}"
echo ""

# Função para verificar se um comando existe
command_exists() {
    command -v "$1" &> /dev/null
}

# Atualizar a lista de pacotes do sistema
echo "Atualizando a lista de pacotes do sistema (apt-get update)..."
sudo apt-get update -y

# Pré-configurar as seleções do phpMyAdmin para evitar interatividade
echo "Pré-configurando phpMyAdmin..."
sudo debconf-set-selections <<< 'phpmyadmin phpmyadmin/dbconfig-install boolean true'
sudo debconf-set-selections <<< 'phpmyadmin phpmyadmin/app-password-confirm password dvsviana'
sudo debconf-set-selections <<< 'phpmyadmin phpmyadmin/mysql/admin-pass password dvsviana'
sudo debconf-set-selections <<< 'phpmyadmin phpmyadmin/mysql/app-pass password dvsviana'
sudo debconf-set-selections <<< 'phpmyadmin phpmyadmin/reconfigure-webserver multiselect apache2'

# Instalar dependências essenciais do sistema (git, curl, apache, mysql, php, build tools)
echo "Instalando pacotes essenciais (git, curl, apache2, mysql-server, phpmyadmin...)"
sudo apt-get install -y git curl build-essential python3 apache2 mysql-server phpmyadmin php-mbstring php-gettext php-zip

# Configurar senha do usuário root do MySQL de forma não-interativa
echo "Configurando a senha do usuário root do MySQL para 'dvsviana'..."
sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'dvsviana';"
sudo mysql -e "FLUSH PRIVILEGES;"
echo -e "${GREEN}Senha do root do MySQL configurada com sucesso.${NC}"

# Verificar e instalar Node.js LTS
if ! command_exists node; then
    echo "Node.js não encontrado. Instalando a versão LTS (20.x)..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
    sudo apt-get install -y nodejs
    echo -e "${GREEN}Node.js LTS instalado com sucesso.${NC}"
else
    echo -e "${GREEN}Node.js já está instalado. Versão: $(node -v)${NC}"
fi

# Verificar e instalar PM2
if ! command_exists pm2; then
    echo "PM2 não encontrado. Instalando globalmente via npm..."
    sudo npm install -g pm2
    echo -e "${GREEN}PM2 instalado com sucesso.${NC}"
else
    echo -e "${GREEN}PM2 já está instalado.${NC}"
fi

echo ""
echo -e "${GREEN}Verificação de dependências concluída.${NC}"
echo ""


# --- 2. Informações de Deploy (Pré-configuradas) ---
GIT_REPO="https://github.com/dimviana/Gestor-de-Boleto.git"
PROJECT_FOLDER="boletomanager.abildeveloper.com.br"
APP_URL="https://boletomanager.abildeveloper.com.br"
DB_HOST="localhost"
DB_USER="root"
DB_PASSWORD="dvsviana"
DB_DATABASE="boleto_manager_ai"
API_KEY="AIzaSyB0zoSEGrIYuRjBtcTvxJX9LVbo5L2GpmA"
JWT_SECRET="AIzaSyB0zoSEGrIYuRjBtcTvxJX9LVbo5L2GpmAjwt"

# Extract port from APP_URL
PORT=$(echo $APP_URL | sed -E 's/.*:([0-9]+)\/?/\1/')
if [[ ! "$PORT" =~ ^[0-9]+$ ]]; then
    PORT=3001 # Default port if not found
fi

# Extract base URL for phpMyAdmin
APP_URL_BASE=$(echo $APP_URL | sed -E 's|:[0-9]+/?$||' | sed 's/\/$//')

echo ""
echo -e "${YELLOW}--- Usando configurações de deploy pré-definidas ---${NC}"
echo "Repositório Git: $GIT_REPO"
echo "Pasta do Projeto: $PROJECT_FOLDER"
echo "URL da Aplicação: $APP_URL"
echo "Porta do Servidor: $PORT"
echo "Banco de Dados: $DB_DATABASE em $DB_HOST"
echo "Usuário do DB: $DB_USER (fixo)"
echo "Senha do DB: [Oculto] (fixo como 'dvsviana')"
echo "API Key Gemini: [Oculto]"
echo "Segredo JWT: [Oculto]"
echo ""

# --- 3. Execução do Deploy ---

# Clonar repositório
if [ -d "$PROJECT_FOLDER" ]; then
    echo -e "${YELLOW}A pasta '$PROJECT_FOLDER' já existe. Removendo para uma nova clonagem...${NC}"
    rm -rf "$PROJECT_FOLDER"
fi
echo -e "${YELLOW}Clonando o repositório...${NC}"
git clone "$GIT_REPO" "$PROJECT_FOLDER"
if [ $? -ne 0 ]; then
    echo -e "${RED}Falha ao clonar o repositório. Verifique a URL e suas permissões.${NC}"
    exit 1
fi
cd "$PROJECT_FOLDER"

# Criar arquivo .env
echo -e "${YELLOW}Criando o arquivo de configuração .env...${NC}"
cat > .env << EOL
# Variáveis de Ambiente para Boleto Manager AI

# Configuração do Banco de Dados MySQL
DB_HOST=${DB_HOST}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
DB_DATABASE=${DB_DATABASE}

# Chave da API do Google Gemini
API_KEY=${API_KEY}

# Configuração do Servidor
PORT=${PORT}

# Segredo JWT para Autenticação
JWT_SECRET=${JWT_SECRET}
EOL
echo -e "${GREEN}Arquivo .env criado com sucesso.${NC}"

# Instalar dependências
echo -e "${YELLOW}Instalando dependências do projeto (npm install)...${NC}"
npm install
if [ $? -ne 0 ]; then
    echo -e "${RED}Falha ao instalar as dependências com npm.${NC}"
    exit 1
fi

# Compilar o projeto (se for TypeScript)
if [ -f "tsconfig.json" ]; then
    echo -e "${YELLOW}Compilando o projeto TypeScript (npm run build)...${NC}"
    npm run build
    if [ $? -ne 0 ]; then
        echo -e "${RED}Falha ao compilar o projeto TypeScript.${NC}"
        exit 1
    fi
fi

# Configurar o banco de dados
echo -e "${YELLOW}Configurando o banco de dados...${NC}"
echo "CREATE DATABASE IF NOT EXISTS \`${DB_DATABASE}\`; USE \`${DB_DATABASE}\`;" > setup.sql
cat database/schema.txt >> setup.sql

echo -e "Executando o script SQL para criar tabelas..."
mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" < setup.sql
if [ $? -ne 0 ]; then
    echo -e "${RED}ERRO: Falha ao executar o script SQL. Verifique as credenciais e o status do MySQL Server.${NC}"
    # Remove password from file on failure for security
    rm setup.sql
    exit 1
fi
rm setup.sql
echo -e "${GREEN}Banco de dados configurado.${NC}"

# Criar usuário administrador padrão
echo -e "${YELLOW}Criando usuário administrador padrão...${NC}"
ADMIN_UUID=$(node -e "console.log(require('crypto').randomUUID());")
ADMIN_PASSWORD="dvsviana154"
HASHED_PASSWORD=$(node -e "console.log(require('bcryptjs').hashSync('${ADMIN_PASSWORD}', 10));")

if [ -z "$HASHED_PASSWORD" ]; then
    echo -e "${RED}ERRO: Falha ao gerar o hash da senha do administrador.${NC}"
    exit 1
fi

INSERT_ADMIN_SQL="INSERT INTO users (id, username, password, role) VALUES ('${ADMIN_UUID}', 'androoiddiviana@gmal.com', '${HASHED_PASSWORD}', 'admin');"

mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" "${DB_DATABASE}" -e "${INSERT_ADMIN_SQL}"

if [ $? -ne 0 ]; then
    echo -e "${RED}ERRO: Falha ao inserir o usuário administrador no banco de dados.${NC}"
    exit 1
fi
echo -e "${GREEN}Usuário administrador 'androoiddiviana@gmal.com' criado com sucesso.${NC}"


# Iniciar a aplicação com PM2
APP_NAME="boleto-manager-ai"
echo -e "${YELLOW}Iniciando a aplicação '$APP_NAME' com PM2...${NC}"

# Parar e deletar a versão antiga, se existir
pm2 stop "$APP_NAME" &> /dev/null
pm2 delete "$APP_NAME" &> /dev/null

# Iniciar nova versão
# Assumindo que o ponto de entrada após o build é 'dist/api/index.js'
pm2 start dist/api/index.js --name "$APP_NAME"

if [ $? -ne 0 ]; then
    echo -e "${RED}Falha ao iniciar a aplicação com PM2.${NC}"
    exit 1
fi

pm2 startup
pm2 save
echo -e "${GREEN}Aplicação iniciada com sucesso via PM2.${NC}"
echo ""

# --- 4. Conclusão ---
echo -e "${GREEN}===================================${NC}"
echo -e "${GREEN}      DEPLOY FINALIZADO!           ${NC}"
echo -e "${GREEN}===================================${NC}"
echo ""
echo -e "A aplicação está rodando e pode ser acessada em: ${YELLOW}${APP_URL}${NC}"
echo -e "O phpMyAdmin está disponível em: ${YELLOW}${APP_URL_BASE}/phpmyadmin${NC}"
echo -e "  (Usuário: root, Senha: dvsviana)"
echo -e "Para ver os logs, use o comando: ${YELLOW}pm2 logs $APP_NAME${NC}"
echo -e "Para parar a aplicação, use o comando: ${YELLOW}pm2 stop $APP_NAME${NC}"
echo ""
