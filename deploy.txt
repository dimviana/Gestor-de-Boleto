#!/bin/bash

# --- Configuration ---
# These variables are now hardcoded for the specific deployment target.
DOMAIN="boletomanager.abildeveloper.com.br"
ADMIN_EMAIL="admin@abildeveloper.com.br" # Used for Let's Encrypt registration and recovery.
GIT_REPO="https://github.com/dimviana/Gestor-de-Boleto.git"
PROJECT_PATH="$HOME/boleto-manager-ai"
NGINX_CONF_NAME="boletomanager"
DB_HOST="localhost"
DB_USER="root"
DB_PASSWORD="your_strong_password_here" # CHANGE THIS IN YOUR SERVER
DB_DATABASE="boleto_manager_ai"
API_KEY="your_gemini_api_key_here" # CHANGE THIS IN YOUR SERVER
JWT_SECRET="your_super_secret_jwt_key_here" # CHANGE THIS IN YOUR SERVER
APP_NAME="boleto-manager-ai"
NODE_PORT=3001

# Color codes for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# --- Helper Functions ---
command_exists() {
    command -v "$1" &> /dev/null
}

# --- Core Functions ---

install_dependencies() {
    echo -e "${YELLOW}Updating system package list...${NC}"
    sudo apt-get update -y

    echo -e "${YELLOW}Installing essential packages (git, nginx, mysql, certbot...)${NC}"
    # Added certbot and its nginx plugin to the installation list
    sudo apt-get install -y git curl build-essential python3 nginx mysql-server certbot python3-certbot-nginx
    if [ $? -ne 0 ]; then echo -e "${RED}Failed to install base packages.${NC}"; exit 1; fi

    if ! command_exists node; then
        echo "Node.js not found. Installing Node.js LTS (20.x)..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        sudo apt-get install -y nodejs
        if [ $? -ne 0 ]; then echo -e "${RED}Failed to install Node.js.${NC}"; exit 1; fi
    else
        echo -e "${GREEN}Node.js is already installed.${NC}"
    fi

    if ! command_exists pm2; then
        echo "PM2 not found. Installing globally..."
        sudo npm install -g pm2
        if [ $? -ne 0 ]; then echo -e "${RED}Failed to install PM2.${NC}"; exit 1; fi
    else
        echo -e "${GREEN}PM2 is already installed.${NC}"
    fi

    echo -e "${GREEN}System dependencies are up to date.${NC}"
}

configure_mysql() {
    echo -e "${YELLOW}Configuring MySQL...${NC}"
    sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '${DB_PASSWORD}';"
    if [ $? -ne 0 ]; then
        echo -e "${YELLOW}Could not set MySQL password. It might be already set. Continuing...${NC}"
    else
        echo -e "${GREEN}MySQL root password configured successfully.${NC}"
    fi
    sudo mysql -e "FLUSH PRIVILEGES;"
}

configure_nginx() {
    echo -e "${YELLOW}Configuring NGINX for ${DOMAIN}...${NC}"
    NGINX_CONFIG_PATH="/etc/nginx/sites-available/${NGINX_CONF_NAME}"
    
    # Create the Nginx config file for HTTP (Certbot will upgrade it to HTTPS)
    sudo tee "$NGINX_CONFIG_PATH" > /dev/null <<EOL
server {
    listen 80;
    server_name ${DOMAIN};

    location / {
        proxy_pass http://localhost:${NODE_PORT};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOL

    # Enable the site by creating a symbolic link
    if [ ! -L "/etc/nginx/sites-enabled/${NGINX_CONF_NAME}" ]; then
        sudo ln -s "$NGINX_CONFIG_PATH" "/etc/nginx/sites-enabled/"
    fi
    
    if [ -L "/etc/nginx/sites-enabled/default" ]; then
        sudo rm "/etc/nginx/sites-enabled/default"
    fi

    sudo nginx -t
    if [ $? -ne 0 ]; then
        echo -e "${RED}NGINX configuration test failed.${NC}"
        exit 1
    fi
    
    sudo systemctl restart nginx
    echo -e "${GREEN}NGINX configured for HTTP validation.${NC}"
}

# --- Main Logic ---

echo -e "${GREEN}====================================================${NC}"
echo -e "${GREEN}  Automated Deployment - Boleto Manager AI          ${NC}"
echo -e "${GREEN}  Target Domain: ${DOMAIN}                    ${NC}"
echo -e "${GREEN}====================================================${NC}"

read -p "This script will perform a full installation. Are you sure? [y/N] " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "Installation cancelled."
    exit 0
fi

install_dependencies
configure_mysql

mkdir -p "$(dirname "$PROJECT_PATH")"

if [ -d "$PROJECT_PATH" ]; then
    echo -e "${YELLOW}Project folder '$PROJECT_PATH' already exists. Removing for a fresh clone.${NC}"
    rm -rf "$PROJECT_PATH"
fi

echo -e "${YELLOW}Cloning repository...${NC}"
git clone "$GIT_REPO" "$PROJECT_PATH"
if [ $? -ne 0 ]; then echo -e "${RED}Failed to clone repository.${NC}"; exit 1; fi
cd "$PROJECT_PATH"

echo -e "${YELLOW}Creating .env configuration file...${NC}"
cat > .env << EOL
DB_HOST=${DB_HOST}
DB_USER=${DB_USER}
DB_PASSWORD=${DB_PASSWORD}
DB_DATABASE=${DB_DATABASE}
API_KEY=${API_KEY}
PORT=${NODE_PORT}
JWT_SECRET=${JWT_SECRET}
EOL

echo -e "${YELLOW}Installing project dependencies (npm install)...${NC}"
npm install
if [ $? -ne 0 ]; then echo -e "${RED}Failed to install npm dependencies.${NC}"; exit 1; fi

echo -e "${YELLOW}Compiling TypeScript project (npm run build)...${NC}"
npm run build
if [ $? -ne 0 ]; then echo -e "${RED}Failed to compile TypeScript project.${NC}"; exit 1; fi

echo -e "${YELLOW}Setting up database schema...${NC}"
echo "CREATE DATABASE IF NOT EXISTS \`${DB_DATABASE}\`;" | mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD"
mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASSWORD" "${DB_DATABASE}" < database/schema.txt
if [ $? -ne 0 ]; then echo -e "${RED}Failed to set up database schema.${NC}"; exit 1; fi

echo -e "${YELLOW}Starting application with PM2...${NC}"
pm2 stop "$APP_NAME" &> /dev/null
pm2 delete "$APP_NAME" &> /dev/null
pm2 start dist/api/index.js --name "$APP_NAME"
pm2 startup
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u $USER --hp /home/$USER
pm2 save

configure_nginx

echo -e "${YELLOW}Requesting SSL Certificate from Let's Encrypt via Certbot...${NC}"
sudo certbot --nginx -d ${DOMAIN} --non-interactive --agree-tos -m ${ADMIN_EMAIL}
if [ $? -ne 0 ]; then
    echo -e "${RED}Certbot failed to obtain an SSL certificate.${NC}"
    echo -e "${YELLOW}Please check your DNS settings for ${DOMAIN} and Nginx logs.${NC}"
    exit 1
fi
echo -e "${GREEN}SSL Certificate obtained and configured successfully!${NC}"

sudo systemctl restart nginx

echo -e "${GREEN}--- Installation Complete! ---${NC}"
echo -e "Application is running via PM2."
echo -e "Access it securely at: ${YELLOW}https://${DOMAIN}${NC}"
echo -e "To see logs, run: ${YELLOW}pm2 logs ${APP_NAME}${NC}"
